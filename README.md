# Sieve App - Path Traversal vulnerability exploitation.

# What's Sieve App?
It's an application where you can store any passwords. I think it was made for App bounty.

# What's the Vulnerability in Sieve?
Sieve uses **Content Provider** to provide the Passwords and other information that are stored on the app's internal database.db file to other apps who might be interested in such information.
This content provider is protected by permissions with a `protectionLevel` of **dangerous** which requires the user approval of such permissions. <br>
In this case, we can't rely on this provider to exploit the information of the database (Well, we can actually exploit it using SQL Injection but yeah this isn't the topic today) <br><br>

`FileBackupProvider.java`: Sieve has another content provider that provides app's internal files and guess what, this one isn't protected by any permissions and it's exported for other app's usage!!!<br>
And now the fun starts!!


# What's the Path Traversal vulnerability?
It's a vulnerability which allows the attackers to access unaccessible files or files that are not intended to be accessible.<br>
It can be done by injecting `/../` symbols in a path and then navigate to other files. <br>
For exanple, we have a path that we are told to access: **/data/data/com.example.test/files/image.png** and after reverse engineering the app, we could find that the app stores a database file internally <br>
mainly in /data/data/packageName/databases/database.db <br><br>
So, we can use the given path and add some backing symbols to go for the database.db file. New path: **/data/data/com.example.test/files/image.png/../../../../../../../data/data/com.example.test/databases/database.db**


# Points to look for before exploitation
- Checking the code that implements `Content Provider` in the vulnerable app and see the implementation of `openFile(uri: Uri, mode: Int)` method, because the developer might be avoiding the vulnerability by using Regular Expressions.
- Check that the `Content Provider` is exported in **AndroidManifest.xml** file by looking at **\<provider android:name="ProviderName" android:exported="true"/>** otherwise, we can't exploit this content provider.
- Check if the provider requires special permissions, if so, it will require extra work with the awareness of the user.
- If we are installing the attacking app on an Android device with version 11 or higher, we need to add the **\<queries/>** tag in the attacking app AndroidManifest.xml first to be able to discover the vulnerable app.


# Exploitation approach
Apps' internal files are secured by the Android Sandbox concept (every app has its own user space with a special user_id), so even if I got the database.db file, I wouldn't be able to construct a database in my app using ``SQLiteDatabase.openDatabase`` because the class doesn't have access to such a file. What the Content Provider does is to provide us the "content" of the file and not the file itself through an `InputStream`, so as you might have already guessed, I did copy the bytes from the stream into a new database file which is now stored in my attacking app's user space. Then I started manipulating the database by executing raw queries on it. I have extracted the column names, and all the records separately. <br>
And of course handling the many many many exceptions that might occur during such a process (copy database, execution of commands, unclosed resources, many infinite loops). I also made the addition of "/../" dynamic so we don't worry how many times should we go back. <br>


# Gallery of exploitation
- Image on left is the attacking app
- Image on right is the Passwords list screen in Sieve app.

<span>
<img src="https://github.com/muhammed9865/sieve-PT-exploitation/assets/84887514/693e1c65-be22-4d2c-a8b3-5e3c385fd717" alt="Home screen" width="300" height="600"> 
<img src="https://github.com/muhammed9865/sieve-PT-exploitation/assets/84887514/fb3a33bc-53b0-4346-ad2e-e42828ad2e5b" alt="Home screen succeeded" width="300" height="600"> 
</span>

